<p>Pacchetti necessari per questa sezione</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>passport passport-jwt bcrypt passport-local mongoose class-transformer
npm <span class="nb">install</span> <span class="nt">--save-dev</span> @types/passport @types/passport-jwt @types/passport-local @types/bcrypt
</code></pre></div></div>

<p>Questa sezione √® dedicata per i file che verranno richiamati da tutti i file del progetto, quindi prima creiamo la cartella <code class="language-plaintext highlighter-rouge">utils</code> e i vari file e aggiorniamo il file <code class="language-plaintext highlighter-rouge">.env</code> <a href="node/00.file_env.md">file .env</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create folders</span>
<span class="nb">mkdir </span>src/utils/auth/jwt
<span class="nb">mkdir </span>src/utils/auth/providers
<span class="nb">mkdir </span>src/utils/auth/providers/local
<span class="nb">mkdir </span>src/utils/auth/providers/google
<span class="nb">mkdir </span>src/utils/auth/providers/github
<span class="nb">mkdir </span>src/utils/auth/user-identity
<span class="nb">mkdir </span>src/utils/consts/types
<span class="nb">mkdir </span>src/utils/consts/enums

<span class="c"># Enum e type user</span>
<span class="nb">touch </span>src/utils/consts/enums/user.enum.ts
<span class="nb">touch </span>src/utils/consts/types/user.type.ts

<span class="c"># Creato per definire la stategia jwt</span>
<span class="nb">mkdir </span>src/api/user
<span class="nb">touch </span>src/api/user/user.entity.ts
<span class="nb">touch </span>src/api/user/user.model.ts

<span class="c"># Utils files</span>
<span class="nb">touch </span>src/utils/greater-than.validator.ts
<span class="nb">touch </span>src/utils/is-populated-obj.ts
<span class="nb">touch </span>src/utils/typed-request.ts
<span class="nb">touch </span>src/utils/validation-middleware.ts
<span class="nb">touch </span>src/utils/dotenv.ts
<span class="nb">touch </span>src/utils/email.template.ts

<span class="c"># Strategy</span>
<span class="nb">touch </span>src/utils/auth/jwt/jwt-strategy.ts
<span class="nb">touch </span>src/utils/auth/providers/local/local-strategy.ts
<span class="nb">touch </span>src/utils/auth/providers/google/google-strategy.ts
<span class="nb">touch </span>src/utils/auth/providers/github/github-strategy.ts

<span class="c"># Identity model</span>
<span class="nb">touch </span>src/utils/auth/user-identity/user-identity.entity.ts
<span class="nb">touch </span>src/utils/auth/user-identity/user-identity.model.ts

<span class="c"># Auth</span>
<span class="nb">touch </span>src/utils/auth/auth-handlers.ts
<span class="nb">touch </span>src/utils/auth/authenticated-middleware.ts
</code></pre></div></div>

<p>L‚Äôuser lo creiamo pi√π avanti, ma per ora per creare la <code class="language-plaintext highlighter-rouge">jwt strategy</code> ci serve l‚Äôinterface e il model dello user, quindi copia questa interface in <code class="language-plaintext highlighter-rouge">src/api/user/user.interface.ts</code> e questo model in <code class="language-plaintext highlighter-rouge">src/api/user/user.model.ts</code></p>

<p><code class="language-plaintext highlighter-rouge">user.interface.ts</code></p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">UserStatus</span><span class="p">,</span> <span class="nx">UserRole</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../utils/consts/types/user.type</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">User</span> <span class="p">{</span>
  <span class="c1">// Unique ID</span>
  <span class="nl">id</span><span class="p">?:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="c1">// Base Info</span>
  <span class="nl">firstName</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">lastName</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">picture</span><span class="p">?:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="c1">// Authentication Info</span>
  <span class="nl">status</span><span class="p">?:</span> <span class="nx">UserStatus</span><span class="p">;</span>
  <span class="nl">role</span><span class="p">?:</span> <span class="nx">UserRole</span><span class="p">;</span>
  <span class="c1">// Security Info</span>
  <span class="nl">createdAt</span><span class="p">?:</span> <span class="nb">Date</span> <span class="o">|</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">lastUpdateAt</span><span class="p">?:</span> <span class="nb">Date</span> <span class="o">|</span> <span class="kr">string</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="nl">lastLogin</span><span class="p">?:</span> <span class="nb">Date</span> <span class="o">|</span> <span class="kr">string</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="nl">lastAllowedIp</span><span class="p">?:</span> <span class="kr">string</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="nl">allowedIps</span><span class="p">?:</span> <span class="kr">string</span><span class="p">[]</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">user.model.ts</code></p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">mongoose</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Document</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">mongoose</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./user.entity</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">USER_ROLE_ENUM</span><span class="p">,</span> <span class="nx">USER_STATUS_ENUM</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../utils/consts/enums/user.enum</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">userSchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span><span class="p">({</span>
  <span class="na">firstName</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span> <span class="p">},</span>
  <span class="na">lastName</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span> <span class="p">},</span>
  <span class="na">picture</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="dl">""</span> <span class="p">},</span>

  <span class="na">status</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">enum</span><span class="p">:</span> <span class="nx">USER_STATUS_ENUM</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">},</span>
  <span class="na">role</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">enum</span><span class="p">:</span> <span class="nx">USER_ROLE_ENUM</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span> <span class="p">},</span>

  <span class="na">createdAt</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">Date</span> <span class="o">||</span> <span class="nb">String</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">},</span>
  <span class="na">lastUpdateAt</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">Date</span> <span class="o">||</span> <span class="nb">String</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">},</span>
  <span class="na">lastLogin</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">Date</span> <span class="o">||</span> <span class="nb">String</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">},</span>
  <span class="na">lastAllowedIp</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">},</span>
  <span class="na">allowedIps</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">],</span> <span class="na">default</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">userSchema</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">toJSON</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">virtuals</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">transform</span><span class="p">:</span> <span class="p">(</span><span class="na">_</span><span class="p">:</span> <span class="nx">Document</span><span class="p">,</span> <span class="na">ret</span><span class="p">:</span> <span class="nb">Record</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">__v</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">userSchema</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="dl">"</span><span class="s2">toObject</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">virtuals</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">transform</span><span class="p">:</span> <span class="p">(</span><span class="na">_</span><span class="p">:</span> <span class="nx">Document</span><span class="p">,</span> <span class="na">ret</span><span class="p">:</span> <span class="nb">Record</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">_id</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">ret</span><span class="p">.</span><span class="nx">__v</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">UserModel</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">"</span><span class="s2">User</span><span class="dl">"</span><span class="p">,</span> <span class="nx">userSchema</span><span class="p">);</span>
</code></pre></div></div>

<p>Nello user model ci servira definire gli enum disponibili per user role e user status, quindi imposta i valori in <code class="language-plaintext highlighter-rouge">src/utils/enums</code> e in <code class="language-plaintext highlighter-rouge">src/utils/types</code></p>

<p><code class="language-plaintext highlighter-rouge">user.enum.ts</code></p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">USER_ROLE_ENUM</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">admin</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">]</span> <span class="kd">as const</span><span class="p">;</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">USER_STATUS_ENUM</span> <span class="o">=</span> <span class="p">[</span><span class="dl">"</span><span class="s2">active</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">inactive</span><span class="dl">"</span><span class="p">];</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">user.type.ts</code></p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">USER_ROLE_ENUM</span><span class="p">,</span> <span class="nx">USER_STATUS_ENUM</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../enums/user.enum</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">type</span> <span class="nx">UserRole</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">USER_ROLE_ENUM</span><span class="p">)[</span><span class="kr">number</span><span class="p">];</span> <span class="c1">// "admin" | "user"</span>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">UserStatus</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">USER_STATUS_ENUM</span><span class="p">)[</span><span class="kr">number</span><span class="p">];</span> <span class="c1">// "active" | "inactive"</span>
</code></pre></div></div>

<p>Adesso che abbiamo preparato i file iniziali possiamo iniziare a scrivere i file di maggiore utilit√† che richiameremo in tutto il progetto</p>

<h3 id="dotenvts"><code class="language-plaintext highlighter-rouge">dotenv.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">dotenv/config</span><span class="dl">"</span><span class="p">;</span> <span class="c1">// Load environment variables from .env file</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">CustomError</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../errors/custom</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">DotEnvError</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../errors/dotenv</span><span class="dl">"</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">RequireEnvOptions</span> <span class="p">{</span>
  <span class="nl">throwOnMissing</span><span class="p">?:</span> <span class="nx">boolean</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// OVERLOADS</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nf">requireEnvVars</span><span class="p">(</span><span class="nx">field</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span><span class="p">;</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nf">requireEnvVars</span><span class="p">(</span>
  <span class="nx">field</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span>
  <span class="nx">options</span><span class="p">:</span> <span class="p">{</span> <span class="nl">throwOnMissing</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}</span>
<span class="p">):</span> <span class="kr">string</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nf">requireEnvVars</span><span class="p">(</span>
  <span class="nx">field</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span>
  <span class="nx">options</span><span class="p">?:</span> <span class="nx">RequireEnvOptions</span>
<span class="p">):</span> <span class="kr">string</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">requireEnvVars</span><span class="p">(</span><span class="nx">fields</span><span class="p">:</span> <span class="kr">string</span><span class="p">[]):</span> <span class="kr">string</span><span class="p">[];</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nf">requireEnvVars</span><span class="p">(</span>
  <span class="nx">fields</span><span class="p">:</span> <span class="kr">string</span><span class="p">[],</span>
  <span class="nx">options</span><span class="p">:</span> <span class="p">{</span> <span class="nl">throwOnMissing</span><span class="p">:</span> <span class="kc">false</span> <span class="p">}</span>
<span class="p">):</span> <span class="p">(</span><span class="kr">string</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">)[];</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nf">requireEnvVars</span><span class="p">(</span>
  <span class="nx">fields</span><span class="p">:</span> <span class="kr">string</span><span class="p">[],</span>
  <span class="nx">options</span><span class="p">?:</span> <span class="nx">RequireEnvOptions</span>
<span class="p">):</span> <span class="kr">string</span><span class="p">[];</span>

<span class="c1">// IMPLEMENTAZIONE UNICA</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nf">requireEnvVars</span><span class="p">(</span>
  <span class="nx">fields</span><span class="p">:</span> <span class="kr">string</span> <span class="o">|</span> <span class="kr">string</span><span class="p">[],</span>
  <span class="nx">options</span><span class="p">:</span> <span class="nx">RequireEnvOptions</span> <span class="o">=</span> <span class="p">{</span> <span class="na">throwOnMissing</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span>
<span class="p">):</span> <span class="nx">unknown</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="p">{</span> <span class="nx">throwOnMissing</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">isMissing</span> <span class="o">=</span> <span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">boolean</span> <span class="o">=&gt;</span>
    <span class="k">typeof</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span> <span class="o">||</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">key</span><span class="p">]?.</span><span class="nf">trim</span><span class="p">()</span> <span class="o">===</span> <span class="dl">""</span><span class="p">;</span>

  <span class="kd">const</span> <span class="nx">getValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="kr">string</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="nf">isMissing</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">throwOnMissing</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">DotEnvError</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">!</span><span class="p">.</span><span class="nf">trim</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nx">fields</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">getValue</span><span class="p">(</span><span class="nx">fields</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if </span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nf">isArray</span><span class="p">(</span><span class="nx">fields</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">fields</span><span class="p">.</span><span class="nf">map</span><span class="p">((</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="nx">key</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">string</span><span class="dl">"</span> <span class="o">||</span> <span class="nx">key</span><span class="p">.</span><span class="nf">trim</span><span class="p">()</span> <span class="o">===</span> <span class="dl">""</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">throwOnMissing</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">DotEnvError</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">undefined</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nf">getValue</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="k">throw</span> <span class="k">new</span> <span class="nc">CustomError</span><span class="p">(</span>
    <span class="dl">"</span><span class="s2">Invalid argument</span><span class="dl">"</span><span class="p">,</span>
    <span class="s2">`Expected a string or an array of strings, but received: </span><span class="p">${</span><span class="k">typeof</span> <span class="nx">fields</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span>
    <span class="mi">400</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">notThrowDotEnvError</span><span class="p">:</span> <span class="nx">RequireEnvOptions</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">throwOnMissing</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Questo file √® stato creato per assicurarsi che tutte le variabili che si richiedono dal file <code class="language-plaintext highlighter-rouge">.env</code> esistano, se non esistono richiamer√† un errore <code class="language-plaintext highlighter-rouge">DotEnvError</code> che ti mostrer√† la variabile che manca nel file <code class="language-plaintext highlighter-rouge">.env</code>. Esiste anche la possibilit√† di non generare errore aggiungendo <code class="language-plaintext highlighter-rouge">notThrowDotEnvError</code> come secondo parametro. Ora vediamo come usarlo</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Richiamare pi√π variabili nello stesso tempo</span>
<span class="kd">const</span> <span class="p">[</span><span class="nx">MONGO_URI</span><span class="p">,</span> <span class="nx">DB_NAME</span><span class="p">,</span> <span class="nx">PORT</span><span class="p">]</span> <span class="o">=</span> <span class="nf">requireEnvVars</span><span class="p">([</span><span class="dl">"</span><span class="s2">MONGO_URI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">DB_NAME</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">PORT</span><span class="dl">"</span><span class="p">]);</span>
<span class="c1">// Richiamo singola variabile</span>
<span class="kd">const</span> <span class="nx">JWT_SECRET</span> <span class="o">=</span> <span class="nf">requireEnvVars</span><span class="p">(</span><span class="dl">"</span><span class="s2">JWT_SECRET</span><span class="dl">"</span><span class="p">);</span>

<span class="c1">// Richiamare pi√π variabili nello stesso tempo senza generare errore</span>
<span class="kd">const</span> <span class="p">[</span><span class="nx">MONGO_URI</span><span class="p">,</span> <span class="nx">DB_NAME</span><span class="p">,</span> <span class="nx">PORT</span><span class="p">]</span> <span class="o">=</span> <span class="nf">requireEnvVars</span><span class="p">([</span><span class="dl">"</span><span class="s2">MONGO_URI</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">DB_NAME</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">PORT</span><span class="dl">"</span><span class="p">],</span> <span class="nx">notThrowDotEnvError</span><span class="p">);</span>
<span class="c1">// Richiamo singola variabile senza generare errore</span>
<span class="kd">const</span> <span class="nx">JWT_SECRET</span> <span class="o">=</span> <span class="nf">requireEnvVars</span><span class="p">(</span><span class="dl">"</span><span class="s2">JWT_SECRET</span><span class="dl">"</span><span class="p">,</span> <span class="nx">notThrowDotEnvError</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="emailtemplatets"><code class="language-plaintext highlighter-rouge">email.template.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">registrationEmailTemplate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">verificationLink</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`
Template della mail con il </span><span class="p">${</span><span class="nx">verificationLink</span><span class="p">}</span><span class="s2"> di verifica della mail
`</span>
</code></pre></div></div>

<p>Questo file conterr√† tutti i template delle mail, da qui verranno chiamati i body di tutte le mail che dovrai inviare</p>

<h3 id="greater-thanvalidatorts"><code class="language-plaintext highlighter-rouge">greater-than.validator.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">registerDecorator</span><span class="p">,</span> <span class="nx">ValidationOptions</span><span class="p">,</span> <span class="nx">ValidationArguments</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">class-validator</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">IsGreaterThan</span><span class="p">(</span><span class="nx">property</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">validationOptions</span><span class="p">?:</span> <span class="nx">ValidationOptions</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nf">function </span><span class="p">(</span><span class="nx">object</span><span class="p">:</span> <span class="nb">Object</span><span class="p">,</span> <span class="nx">propertyName</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">registerDecorator</span><span class="p">({</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">isGreaterThan</span><span class="dl">'</span><span class="p">,</span>
      <span class="na">target</span><span class="p">:</span> <span class="nx">object</span><span class="p">.</span><span class="kd">constructor</span><span class="p">,</span>
      <span class="na">propertyName</span><span class="p">:</span> <span class="nx">propertyName</span><span class="p">,</span>
      <span class="na">constraints</span><span class="p">:</span> <span class="p">[</span><span class="nx">property</span><span class="p">],</span>
      <span class="na">options</span><span class="p">:</span> <span class="nx">validationOptions</span><span class="p">,</span>
      <span class="na">validator</span><span class="p">:</span> <span class="p">{</span>
        <span class="nf">validate</span><span class="p">(</span><span class="na">value</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="na">args</span><span class="p">:</span> <span class="nx">ValidationArguments</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">const</span> <span class="p">[</span><span class="nx">relatedPropertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">constraints</span><span class="p">;</span>
          <span class="kd">const</span> <span class="nx">relatedValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">object</span> <span class="kd">as </span><span class="kr">any</span><span class="p">)[</span><span class="nx">relatedPropertyName</span><span class="p">];</span>
          <span class="k">return</span> <span class="nx">relatedValue</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">?</span> <span class="nx">value</span> <span class="o">&gt;</span> <span class="nx">relatedValue</span> <span class="p">:</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">},</span>
      <span class="p">},</span>
    <span class="p">});</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Il decoratore <code class="language-plaintext highlighter-rouge">IsGreaterThan</code> √® un <strong>custom validator</strong>. Il suo scopo √® quello di verificare che <strong>il valore di una propriet√† sia maggiore</strong> rispetto al valore di un‚Äôaltra propriet√† dello stesso oggetto. Ora vediamo qualche caso d‚Äôuso</p>

<p>Range numerico</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">IsGreaterThan</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./is-greater-than.decorator</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">IsNumber</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">class-validator</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">RangeDto</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">IsNumber</span><span class="p">()</span>
  <span class="nx">min</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsNumber</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">IsGreaterThan</span><span class="p">(</span><span class="dl">'</span><span class="s1">min</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">max deve essere maggiore di min</span><span class="dl">'</span> <span class="p">})</span>
  <span class="nx">max</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span> <span class="nx">dto</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RangeDto</span><span class="p">();</span>
<span class="nx">dto</span><span class="p">.</span><span class="nx">min</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="nx">dto</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
<span class="c1">// Validazione OK</span>

<span class="nx">dto</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="c1">// ‚ùå Errore: "max deve essere maggiore di min"</span>
</code></pre></div></div>

<p>Range di date</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">IsDate</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">class-validator</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">PeriodDto</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">IsDate</span><span class="p">()</span>
  <span class="nx">startDate</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>

  <span class="p">@</span><span class="nd">IsDate</span><span class="p">()</span>
  <span class="p">@</span><span class="nd">IsGreaterThan</span><span class="p">(</span><span class="dl">'</span><span class="s1">startDate</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">'</span><span class="s1">La data di fine deve essere successiva a quella di inizio</span><span class="dl">'</span> <span class="p">})</span>
  <span class="nx">endDate</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Uso</span>
<span class="kd">const</span> <span class="nx">dto</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PeriodDto</span><span class="p">();</span>
<span class="nx">dto</span><span class="p">.</span><span class="nx">startDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="dl">'</span><span class="s1">2025-06-01</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">dto</span><span class="p">.</span><span class="nx">endDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="dl">'</span><span class="s1">2025-06-10</span><span class="dl">'</span><span class="p">);</span>
<span class="c1">// ‚úÖ OK</span>

<span class="nx">dto</span><span class="p">.</span><span class="nx">endDate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="dl">'</span><span class="s1">2025-05-30</span><span class="dl">'</span><span class="p">);</span>
<span class="c1">// ‚ùå Errore: "La data di fine deve essere successiva a quella di inizio"</span>
</code></pre></div></div>

<h3 id="is-populated-objts"><code class="language-plaintext highlighter-rouge">is-populated-obj.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">isObjectIdOrHexString</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">mongoose</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">isPopulated</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="kr">string</span> <span class="p">}</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">arg</span><span class="p">:</span> <span class="kr">string</span> <span class="o">|</span> <span class="nx">T</span><span class="p">):</span> <span class="nx">arg</span> <span class="k">is</span> <span class="nx">T</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="nf">isObjectIdOrHexString</span><span class="p">(</span><span class="nx">arg</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Questa funzione TypeScript si chiama <code class="language-plaintext highlighter-rouge">isPopulated</code> e serve per distinguere tra:</p>
<ul>
  <li>un <strong>ObjectId</strong> (in formato stringa), <strong>non popolato</strong></li>
  <li>e un <strong>oggetto Mongoose popolato</strong>, ovvero un documento con propriet√† (incluso <code class="language-plaintext highlighter-rouge">id</code>)
Vediamo un esempio pratico</li>
</ul>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">60d21b4667d0d8992e610c85</span><span class="dl">'</span><span class="p">;</span> <span class="c1">// ObjectId string</span>
<span class="kd">const</span> <span class="nx">populatedUser</span> <span class="o">=</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">60d21b...</span><span class="dl">'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Mario</span><span class="dl">'</span> <span class="p">};</span> <span class="c1">// Oggetto popolato</span>

<span class="nf">isPopulated</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>          <span class="c1">// false</span>
<span class="nf">isPopulated</span><span class="p">(</span><span class="nx">populatedUser</span><span class="p">);</span> <span class="c1">// true</span>
</code></pre></div></div>

<h3 id="typed-requestts"><code class="language-plaintext highlighter-rouge">typed-request.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Request</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">express</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ParamsDictionary</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">express-serve-static-core</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ParsedQs</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">qs</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">TypedRequest</span><span class="o">&lt;</span><span class="nx">T</span> <span class="o">=</span> <span class="nx">unknown</span><span class="p">,</span> <span class="nx">Q</span> <span class="o">=</span> <span class="nx">ParsedQs</span><span class="p">,</span> <span class="nx">P</span> <span class="o">=</span> <span class="nx">ParamsDictionary</span><span class="o">&gt;</span>
  <span class="kd">extends</span> <span class="nx">Request</span><span class="o">&lt;</span><span class="nx">P</span><span class="p">,</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">T</span><span class="p">,</span> <span class="nx">Q</span><span class="o">&gt;</span> <span class="p">{}</span>

<span class="k">export</span> <span class="kd">type</span> <span class="nx">RequestWithBody</span><span class="o">&lt;</span><span class="nx">B</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">TypedRequest</span><span class="o">&lt;</span><span class="nx">B</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">RequestWithQuery</span><span class="o">&lt;</span><span class="nx">Q</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">TypedRequest</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="p">,</span> <span class="nx">Q</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">export</span> <span class="kd">type</span> <span class="nx">RequestWithParams</span><span class="o">&lt;</span><span class="nx">P</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">TypedRequest</span><span class="o">&lt;</span><span class="nx">unknown</span><span class="p">,</span> <span class="nx">unknown</span><span class="p">,</span> <span class="nx">P</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div></div>

<p>Questa interface molto complicata a prima vista ti permette di tipizzare le richieste che fai di solito con express, ora vediamo qualche esempio. Se ti serve solo un campo di richiesta (<code class="language-plaintext highlighter-rouge">body</code>, <code class="language-plaintext highlighter-rouge">query</code> o <code class="language-plaintext highlighter-rouge">param</code>) allora usa i 3 tipi esportati in basso, se te ne servono 2 o piu usa <code class="language-plaintext highlighter-rouge">TypedRequest</code> tenendo conto che devi andare in ordine, ovvero <code class="language-plaintext highlighter-rouge">body</code>, <code class="language-plaintext highlighter-rouge">query</code> e poi <code class="language-plaintext highlighter-rouge">param</code>, se te ne servono solo 2 scrivi <code class="language-plaintext highlighter-rouge">unknown</code> sul campo mancante</p>

<p>Con <code class="language-plaintext highlighter-rouge">Request</code> standard:</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Request</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">express</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">Request</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>   <span class="c1">// tipo: any</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>  <span class="c1">// tipo: ParsedQs (generico)</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">;</span> <span class="c1">// tipo: ParamsDictionary (generico)</span>
<span class="p">};</span>
</code></pre></div></div>

<ul>
  <li>‚ùå <strong>Poca intelligenza dell‚ÄôIDE</strong></li>
  <li>‚ùå Devi ricordarti ‚Äúa mano‚Äù come sono fatti i dati</li>
  <li>‚ùå Pi√π facile fare errori di tipo</li>
</ul>

<h3 id="con-typedrequest">Con <code class="language-plaintext highlighter-rouge">TypedRequest</code>:</h3>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">type</span> <span class="nx">Body</span> <span class="o">=</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="kr">string</span> <span class="p">};</span>
<span class="kd">type</span> <span class="nx">Query</span> <span class="o">=</span> <span class="p">{</span> <span class="na">debug</span><span class="p">:</span> <span class="nx">boolean</span> <span class="p">};</span>
<span class="kd">type</span> <span class="nx">Params</span> <span class="o">=</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="kr">string</span> <span class="p">};</span>

<span class="kd">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">req</span><span class="p">:</span> <span class="nx">TypedRequest</span><span class="o">&lt;</span><span class="nx">Body</span><span class="p">,</span> <span class="nx">Query</span><span class="p">,</span> <span class="nx">Params</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>    <span class="c1">// ‚úÖ TypeScript sa che √® string</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">debug</span><span class="p">;</span>  <span class="c1">// ‚úÖ boolean</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>    <span class="c1">// ‚úÖ string</span>
<span class="p">};</span>

</code></pre></div></div>

<ul>
  <li>‚úÖ <strong>Autocompletamento</strong></li>
  <li>‚úÖ <strong>Validazione a compile-time</strong></li>
  <li>‚úÖ IDE ti aiuta a non sbagliare
    <h4 id="-in-sintesi">üí° In sintesi</h4>
  </li>
</ul>

<table>
  <thead>
    <tr>
      <th><code class="language-plaintext highlighter-rouge">Request</code> di Express</th>
      <th><code class="language-plaintext highlighter-rouge">TypedRequest</code> personalizzato</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Generico, non tipizzato</td>
      <td>Tipi forti su <code class="language-plaintext highlighter-rouge">body</code>, <code class="language-plaintext highlighter-rouge">query</code>, <code class="language-plaintext highlighter-rouge">params</code></td>
    </tr>
    <tr>
      <td>Rischio errori a runtime</td>
      <td>Errori presi in fase di compilazione</td>
    </tr>
    <tr>
      <td>Nessun autocomplete utile</td>
      <td>Intellisense completo</td>
    </tr>
  </tbody>
</table>

<h4 id="-quando-ti-serve">üß† Quando ti serve?</h4>

<p>Usa <code class="language-plaintext highlighter-rouge">TypedRequest</code> <strong>quando vuoi maggiore sicurezza</strong> e chiarezza, soprattutto in:</p>
<ul>
  <li>Controller REST (es. <code class="language-plaintext highlighter-rouge">GET /users/:id</code>)</li>
  <li>API complesse con parametri e query</li>
  <li>Team di sviluppo (per evitare malintesi)</li>
</ul>

<h3 id="validation-middlewarets"><code class="language-plaintext highlighter-rouge">validation-middleware.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">NextFunction</span><span class="p">,</span> <span class="nx">Response</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">express</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">plainToClass</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">class-transformer</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">validate</span> <span class="kd">as </span><span class="nx">classValidate</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">class-validator</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ValidationError</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../errors/validation</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">TypedRequest</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./typed-request</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">function</span> <span class="nf">validateFn</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="nx">object</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="kd">type</span><span class="p">:</span> <span class="k">new </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span>
<span class="p">):</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">TypedRequest</span><span class="o">&lt;</span><span class="nx">T</span><span class="p">,</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>
<span class="kd">function</span> <span class="nf">validateFn</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="nx">object</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="kd">type</span><span class="p">:</span> <span class="k">new </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">,</span>
  <span class="nx">origin</span><span class="p">:</span> <span class="dl">"</span><span class="s2">body</span><span class="dl">"</span>
<span class="p">):</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">TypedRequest</span><span class="o">&lt;</span><span class="nx">T</span><span class="p">,</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>
<span class="kd">function</span> <span class="nf">validateFn</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="nx">object</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="kd">type</span><span class="p">:</span> <span class="k">new </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">,</span>
  <span class="nx">origin</span><span class="p">:</span> <span class="dl">"</span><span class="s2">query</span><span class="dl">"</span>
<span class="p">):</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">TypedRequest</span><span class="o">&lt;</span><span class="kr">any</span><span class="p">,</span> <span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>
<span class="kd">function</span> <span class="nf">validateFn</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="nx">object</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="kd">type</span><span class="p">:</span> <span class="k">new </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">,</span>
  <span class="nx">origin</span><span class="p">:</span> <span class="dl">"</span><span class="s2">params</span><span class="dl">"</span>
<span class="p">):</span> <span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">TypedRequest</span><span class="o">&lt;</span><span class="kr">any</span><span class="p">,</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">;</span>
<span class="kd">function</span> <span class="nf">validateFn</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="nx">object</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="kd">type</span><span class="p">:</span> <span class="k">new </span><span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">T</span><span class="p">,</span>
  <span class="nx">origin</span><span class="p">:</span> <span class="dl">"</span><span class="s2">body</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">query</span><span class="dl">"</span> <span class="o">|</span> <span class="dl">"</span><span class="s2">params</span><span class="dl">"</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">body</span><span class="dl">"</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">async </span><span class="p">(</span><span class="nx">req</span><span class="p">:</span> <span class="nx">TypedRequest</span><span class="o">&lt;</span><span class="kr">any</span><span class="p">,</span> <span class="kr">any</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">res</span><span class="p">:</span> <span class="nx">Response</span><span class="p">,</span> <span class="nx">next</span><span class="p">:</span> <span class="nx">NextFunction</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nf">plainToClass</span><span class="p">(</span><span class="kd">type</span><span class="p">,</span> <span class="nx">req</span><span class="p">[</span><span class="nx">origin</span><span class="p">]);</span>
    <span class="kd">const</span> <span class="nx">errors</span> <span class="o">=</span> <span class="k">await</span> <span class="nf">classValidate</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">errors</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">next</span><span class="p">(</span><span class="k">new</span> <span class="nc">ValidationError</span><span class="p">(</span><span class="nx">errors</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">req</span><span class="p">[</span><span class="nx">origin</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
      <span class="nf">next</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">validate</span> <span class="o">=</span> <span class="nx">validateFn</span><span class="p">;</span>
</code></pre></div></div>

<p>Questo <code class="language-plaintext highlighter-rouge">middleware</code> serve per</p>
<ul>
  <li><strong>Convertire</strong> i dati ricevuti (<code class="language-plaintext highlighter-rouge">req.body</code>, <code class="language-plaintext highlighter-rouge">req.query</code>, o <code class="language-plaintext highlighter-rouge">req.params</code>) nel tipo di classe (<code class="language-plaintext highlighter-rouge">DTO</code>) che gli passi.</li>
  <li>Se i dati sono <strong>invalidi</strong>, chiama <code class="language-plaintext highlighter-rouge">next()</code> con un errore di validazione (personalizzato: <code class="language-plaintext highlighter-rouge">ValidationError</code>). -&gt; <a href="node/02.errors_handling.md">vedi errori</a></li>
</ul>

<p>Esempio pratico</p>
<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// In questo caso valida il body</span>
<span class="nx">router</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/register</span><span class="dl">"</span><span class="p">,</span> <span class="nf">validate</span><span class="p">(</span><span class="nx">AddUserDTO</span><span class="p">),</span> <span class="nx">add</span><span class="p">);</span>

<span class="c1">// Validazione di tutte le richieste</span>
<span class="nf">validate</span><span class="p">(</span><span class="nx">SomeDto</span><span class="p">,</span> <span class="dl">"</span><span class="s2">body</span><span class="dl">"</span><span class="p">)</span> <span class="c1">// Default</span>
<span class="nf">validate</span><span class="p">(</span><span class="nx">SomeDto</span><span class="p">,</span> <span class="dl">"</span><span class="s2">query</span><span class="dl">"</span><span class="p">)</span>
<span class="nf">validate</span><span class="p">(</span><span class="nx">SomeDto</span><span class="p">,</span> <span class="dl">"</span><span class="s2">params</span><span class="dl">"</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="creazione-jwt-strategy">Creazione jwt strategy</h2>

<h3 id="auth-handlersts"><code class="language-plaintext highlighter-rouge">auth-handlers.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">./jwt/jwt-strategy</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">./providers/local/local-strategy</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">./providers/google/google-strategy</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">./providers/github/github-strategy</span><span class="dl">"</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="kd">as </span><span class="nx">myUser</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../api/user/user.entity</span><span class="dl">"</span><span class="p">;</span>

<span class="kr">declare</span> <span class="nb">global</span> <span class="p">{</span>
  <span class="k">namespace</span> <span class="nx">Express</span> <span class="p">{</span>
    <span class="kr">interface</span> <span class="nx">User</span> <span class="kd">extends</span> <span class="nx">myUser</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="-cosa-fanno-questi-import">‚úÖ <strong>Cosa fanno questi import?</strong></h3>

<p>Questi <strong>non importano nulla ‚Äúesplicitamente‚Äù</strong>, ma eseguono <strong>il file per i suoi effetti collaterali</strong> (side effects).
üëâ √à un pattern usato per ‚Äúattivare‚Äù qualcosa al caricamento del modulo.
Ho gi√† predisposto anche gli import per i providers di google e github ma al momento sono solo file vuoti</p>

<h3 id="-in-pratica-questi-file-vengono-eseguiti-per-fare-una-cosa-come">üß† <strong>In pratica, questi file vengono eseguiti per fare una cosa come:</strong></h3>

<ul>
  <li>Registrare strategie Passport (JWT, GitHub, Google, Local)</li>
  <li>Inizializzare configurazioni globali (per collegare l‚Äôinterface del nostro User alle varie strategy)</li>
  <li>Agganciare middleware o estensioni</li>
</ul>

<p>Adesso capiamo a cosa serve la parte del <code class="language-plaintext highlighter-rouge">declare</code></p>
<h2 id="-obiettivo-principale">‚úÖ <strong>Obiettivo principale:</strong></h2>

<p>Estendere il tipo <code class="language-plaintext highlighter-rouge">Express.User</code> per <strong>aggiungere le propriet√† del tuo <code class="language-plaintext highlighter-rouge">User</code> personalizzato</strong> cos√¨ che <code class="language-plaintext highlighter-rouge">req.user</code> abbia il <strong>tipo corretto in TypeScript</strong>.</p>

<h3 id="authenticated-middlewarets"><code class="language-plaintext highlighter-rouge">authenticated-middleware.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">passport</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">passport</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">isAuthenticated</span> <span class="o">=</span> <span class="nx">passport</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="dl">"</span><span class="s2">jwt</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">session</span><span class="p">:</span> <span class="kc">false</span> <span class="p">});</span>
</code></pre></div></div>

<h2 id="-a-cosa-serve-isauthenticated">üîê A cosa serve <code class="language-plaintext highlighter-rouge">isAuthenticated</code>?</h2>

<p>Questa riga crea un <strong>middleware Express</strong> che usa Passport per:</p>

<ol>
  <li><strong>Verificare</strong> che la richiesta contenga un JWT valido (JSON Web Token)</li>
  <li><strong>Autenticare l‚Äôutente</strong> in base a quel token</li>
  <li><strong>Bloccare l‚Äôaccesso</strong> se il token non √® valido, scaduto, o assente</li>
</ol>

<h2 id="Ô∏è-come-funziona">üõ†Ô∏è Come funziona</h2>

<p><code class="language-plaintext highlighter-rouge">passport.authenticate("jwt")</code> fa riferimento a una <strong>strategia registrata</strong> precedentemente nel tuo file <code class="language-plaintext highlighter-rouge">jwt-strategy.ts</code> (che tu hai importato all‚Äôavvio del server).</p>

<h2 id="-quando-usi">üîÅ Quando usi:</h2>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nx">isAuthenticated</span><span class="p">);</span>
</code></pre></div></div>

<p>Significa: <strong>‚Äútutte le route che seguono richiedono un utente autenticato con un JWT valido.‚Äù</strong></p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">/me</span><span class="dl">"</span><span class="p">,</span> <span class="nx">isAuthenticated</span><span class="p">,</span> <span class="nx">me</span><span class="p">);</span>
</code></pre></div></div>

<p>oppure in una singola chiamata nel router</p>
<h2 id="-dettagli-dellopzione--session-false-">üîé Dettagli dell‚Äôopzione <code class="language-plaintext highlighter-rouge">{ session: false }</code></h2>

<ul>
  <li>Disabilita l‚Äôuso delle <strong>sessioni</strong> (che Passport supporta di default)</li>
  <li>Siccome JWT √® <strong>stateless</strong>, non hai bisogno di salvare sessioni sul server</li>
</ul>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">passport</span><span class="p">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="dl">"</span><span class="s2">jwt</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">session</span><span class="p">:</span> <span class="kc">false</span> <span class="p">});</span>
</code></pre></div></div>

<p>significa: _‚Äúautentica con JWT, senza salvare nulla nel server.‚Äù</p>

<h3 id="jwt-strategyts"><code class="language-plaintext highlighter-rouge">jwt-strategy.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="dl">"</span><span class="s2">dotenv/config</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">passport</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">passport</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">ExtractJwt</span><span class="p">,</span> <span class="nx">VerifiedCallback</span><span class="p">,</span> <span class="nx">Strategy</span> <span class="kd">as </span><span class="nx">JwtStrategy</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">passport-jwt</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">UserModel</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../../api/user/user.model</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">requireEnvVars</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../../utils/dotenv</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">JWT_SECRET</span> <span class="o">=</span> <span class="nf">requireEnvVars</span><span class="p">(</span><span class="dl">"</span><span class="s2">JWT_SECRET</span><span class="dl">"</span><span class="p">);</span>

<span class="nx">passport</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span>
  <span class="k">new</span> <span class="nc">JwtStrategy</span><span class="p">(</span>
    <span class="p">{</span>
      <span class="na">jwtFromRequest</span><span class="p">:</span> <span class="nx">ExtractJwt</span><span class="p">.</span><span class="nf">fromAuthHeaderAsBearerToken</span><span class="p">(),</span>
      <span class="na">secretOrKey</span><span class="p">:</span> <span class="nx">JWT_SECRET</span>
    <span class="p">},</span>
    <span class="k">async </span><span class="p">(</span><span class="nx">payload</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">done</span><span class="p">:</span> <span class="nx">VerifiedCallback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">UserModel</span><span class="p">.</span><span class="nf">findById</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
          <span class="nf">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">.</span><span class="nf">toObject</span><span class="p">());</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nf">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">invalid token</span><span class="dl">"</span> <span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="p">);</span>
</code></pre></div></div>

<h2 id="-in-sintesi-cosa-fa-questo-file">üîê <strong>In sintesi: cosa fa questo file</strong></h2>

<ol>
  <li><strong>Configura</strong> Passport per usare i token JWT (JSON Web Token)</li>
  <li>Estrae il token dalla richiesta (<code class="language-plaintext highlighter-rouge">Authorization: Bearer ...</code> -&gt; <code class="language-plaintext highlighter-rouge">ExtractJwt.fromAuthHeaderAsBearerToken()</code>)</li>
  <li>Decodifica e verifica il token con una <strong>chiave segreta</strong> presente nel file <code class="language-plaintext highlighter-rouge">.env</code></li>
  <li>Se il token √® valido, recupera l‚Äôutente dal database e lo attacca come <code class="language-plaintext highlighter-rouge">req.user</code></li>
  <li>Se non √® valido o non trova l‚Äôutente ‚Üí fallisce con errore <code class="language-plaintext highlighter-rouge">401 Unauthorized</code></li>
</ol>

<h3 id="local-strategyts"><code class="language-plaintext highlighter-rouge">local-strategy.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">passport</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">passport</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Strategy</span> <span class="kd">as </span><span class="nx">LocalStrategy</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">passport-local</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="kd">as </span><span class="nx">bcrypt</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">bcrypt</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">UserIdentityModel</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../user-identity/user-identity.model</span><span class="dl">"</span><span class="p">;</span>

<span class="nx">passport</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span>
  <span class="k">new</span> <span class="nc">LocalStrategy</span><span class="p">(</span>
    <span class="p">{</span>
      <span class="na">usernameField</span><span class="p">:</span> <span class="dl">"</span><span class="s2">username</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">passwordField</span><span class="p">:</span> <span class="dl">"</span><span class="s2">password</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">session</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">},</span>
    <span class="k">async </span><span class="p">(</span><span class="nx">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">password</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">identity</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">UserIdentityModel</span><span class="p">.</span><span class="nf">findOne</span><span class="p">({</span>
          <span class="dl">"</span><span class="s2">credentials.username</span><span class="dl">"</span><span class="p">:</span> <span class="nx">username</span>
        <span class="p">});</span>
        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">identity</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nf">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">message</span><span class="p">:</span> <span class="s2">`username </span><span class="p">${</span><span class="nx">username</span><span class="p">}</span><span class="s2"> not found`</span>
          <span class="p">});</span>
        <span class="p">}</span>
        <span class="kd">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nf">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">identity</span><span class="p">.</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">hashedPassword</span><span class="p">);</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nf">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">identity</span><span class="p">.</span><span class="nf">toObject</span><span class="p">().</span><span class="nx">user</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nf">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">invalid password</span><span class="dl">"</span> <span class="p">});</span>
      <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">done</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">)</span>
<span class="p">);</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">isValidResendEmail</span><span class="p">(</span><span class="nx">lastSent</span><span class="p">:</span> <span class="nb">Date</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">oneHour</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">lastSent</span> <span class="o">||</span> <span class="nx">now</span><span class="p">.</span><span class="nf">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="nx">lastSent</span><span class="p">).</span><span class="nf">getTime</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">oneHour</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Questo file si occupa di fare l‚Äôautenticazione con <code class="language-plaintext highlighter-rouge">passport-local</code>, vediamo come viene creata la configurazione della strategia</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">new</span> <span class="nx">LocalStrategy</span><span class="p">(</span>
<span class="p">{</span>
  <span class="na">usernameField</span><span class="p">:</span> <span class="dl">"</span><span class="s2">username</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">passwordField</span><span class="p">:</span> <span class="dl">"</span><span class="s2">password</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">session</span><span class="p">:</span> <span class="kc">false</span>
<span class="p">},</span>
</code></pre></div></div>

<p>Stiamo dicendo a Passport:</p>

<ul>
  <li>Quando ricevi una richiesta di login:
    <ul>
      <li>Leggi <code class="language-plaintext highlighter-rouge">req.body.username</code> come username.</li>
      <li>Leggi <code class="language-plaintext highlighter-rouge">req.body.password</code> come password.</li>
      <li>Non salvare una sessione (quindi niente <code class="language-plaintext highlighter-rouge">req.login()</code> o sessioni con cookie).</li>
    </ul>
  </li>
</ul>

<p>Callback per la verifica</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">identity</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">UserIdentityModel</span><span class="p">.</span><span class="nf">findOne</span><span class="p">({</span>
          <span class="dl">"</span><span class="s2">credentials.username</span><span class="dl">"</span><span class="p">:</span> <span class="nx">username</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Cerca nel database un documento dove <code class="language-plaintext highlighter-rouge">credentials.username === username</code> (quindi il campo <code class="language-plaintext highlighter-rouge">username</code> √® <strong>nidificato</strong> dentro <code class="language-plaintext highlighter-rouge">credentials</code>).</p>

<p>Gestione utente non trovato</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">identity</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span>
		<span class="na">message</span><span class="p">:</span> <span class="s2">`username </span><span class="p">${</span><span class="nx">username</span><span class="p">}</span><span class="s2"> not found`</span>
	<span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Se non esiste nessun documento con quel <code class="language-plaintext highlighter-rouge">username</code>, la strategia <strong>fallisce</strong>.</li>
  <li><code class="language-plaintext highlighter-rouge">done(null, false, { message })</code> segnala a Passport che l‚Äôautenticazione √® fallita.</li>
</ul>

<p>Verifica della password</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">bcrypt</span><span class="p">.</span><span class="nf">compare</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span> <span class="nx">identity</span><span class="p">.</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">hashedPassword</span><span class="p">);</span>
</code></pre></div></div>

<p>Usa <code class="language-plaintext highlighter-rouge">bcrypt.compare</code> per confrontare la password inviata con quella <strong>criptata</strong> nel database. Se la password √® corretta:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if </span><span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nf">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">identity</span><span class="p">.</span><span class="nf">toObject</span><span class="p">().</span><span class="nx">user</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Se la password √® giusta, si chiama <code class="language-plaintext highlighter-rouge">done</code> con l‚Äôoggetto <code class="language-plaintext highlighter-rouge">user</code> associato a quell‚Äôidentit√†.</li>
  <li>Questo oggetto sar√† disponibile nel <code class="language-plaintext highlighter-rouge">req.user</code>.</li>
</ul>

<p>Se la password √® sbagliata</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="p">{</span> <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">invalid password</span><span class="dl">"</span> <span class="p">});</span>
</code></pre></div></div>

<p>Adesso i file <code class="language-plaintext highlighter-rouge">user-identity.entity.ts</code> e <code class="language-plaintext highlighter-rouge">user-identity.model.ts</code> servono per creare nel database una <code class="language-plaintext highlighter-rouge">collezione</code> che salverai a database che contiene l‚Äôusername, la password (criptata) e il riferimento allo user, oltre a valori come <code class="language-plaintext highlighter-rouge">isActive</code> che serve per verificare se l‚Äôuser ha verificato la mail e vari token utili per funzionalit√† che vedremo in futuro</p>

<h3 id="altre-implementazioni-consigliate---rate-limiter">Altre implementazioni consigliate - <code class="language-plaintext highlighter-rouge">Rate limiter</code></h3>

<h4 id="Ô∏è-cos√®-un-rate-limiter">üõ°Ô∏è Cos‚Äô√® un Rate Limiter?</h4>

<p>Un <strong>Rate Limiter</strong> √® un middleware che serve a <strong>limitare il numero di richieste</strong> che un client pu√≤ fare a un endpoint <strong>in un certo intervallo di tempo</strong>.</p>

<h3 id="Ô∏è-serve-a">‚ú≥Ô∏è Serve a:</h3>

<ul>
  <li>Bloccare <strong>attacchi brute force</strong> (es. login ripetuto con password diverse)</li>
  <li>Evitare <strong>abusi</strong> dell‚ÄôAPI (es. chiamate spam)</li>
  <li>Proteggere l‚Äôinfrastruttura da <strong>sovraccarichi</strong> (es. DoS)</li>
  <li>Mantenere l‚Äô<strong>equit√† d‚Äôuso</strong> delle API (fair usage)</li>
</ul>

<h3 id="-come-si-usa-express-rate-limit">üöÄ Come si usa <code class="language-plaintext highlighter-rouge">express-rate-limit</code></h3>

<h4 id="1-installazione">1. <strong>Installazione</strong></h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>express-rate-limit
</code></pre></div></div>

<h4 id="2-import-e-configurazione-base">2. <strong>Import e configurazione base</strong></h4>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// src/middlewares/rate-limiter.ts</span>
<span class="k">import</span> <span class="nx">rateLimit</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">express-rate-limit</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">loginRateLimiter</span> <span class="o">=</span> <span class="nf">rateLimit</span><span class="p">({</span>
  <span class="na">windowMs</span><span class="p">:</span> <span class="mi">15</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="c1">// 15 minuti</span>
  <span class="na">max</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="c1">// massimo 10 richieste per IP</span>
  <span class="na">standardHeaders</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// include header RateLimit-* nelle risposte</span>
  <span class="na">legacyHeaders</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>  <span class="c1">// disattiva X-RateLimit-* obsoleti</span>
  <span class="na">message</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">error</span><span class="p">:</span> <span class="dl">"</span><span class="s2">TooManyRequests</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Troppi tentativi di login. Riprova tra 15 minuti.</span><span class="dl">"</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>

<h4 id="25-possibili-domande">2.5 Possibili domande</h4>

<h6 id="-windowms-15--60--1000">‚ùì <code class="language-plaintext highlighter-rouge">windowMs: 15 * 60 * 1000</code></h6>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">windowMs</span><span class="p">:</span> <span class="mi">15</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span> <span class="c1">// 15 minuti in millisecondi</span>
</code></pre></div></div>

<h4 id="-cosa-fa">‚úÖ COSA FA:</h4>

<p>Definisce <strong>l‚Äôintervallo di tempo (finestra)</strong> durante il quale viene conteggiato il numero massimo di richieste (<code class="language-plaintext highlighter-rouge">max</code>) <strong>per ogni client</strong>.</p>

<h4 id="-come-funziona">üîç COME FUNZIONA:</h4>

<ul>
  <li>La <strong>finestra parte dalla prima richiesta</strong> fatta da un determinato client (es. IP) e <strong>dura 15 minuti</strong>.</li>
  <li>Durante quella finestra, se fai pi√π di <code class="language-plaintext highlighter-rouge">max</code> richieste, vieni bloccato con errore <code class="language-plaintext highlighter-rouge">429 Too Many Requests</code>.</li>
</ul>

<p>‚úÖ <strong>Non importa se la richiesta ha successo o fallisce</strong>: ogni chiamata valida HTTP <strong>conta nel limite</strong>.</p>

<h4 id="-esempio">üìå Esempio:</h4>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">windowMs</span><span class="p">:</span> <span class="mi">15</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span> <span class="c1">// 15 min</span>
<span class="nx">max</span><span class="p">:</span> <span class="mi">10</span>
</code></pre></div></div>

<ul>
  <li>Utente fa 10 chiamate in 5 minuti ‚Üí tutto OK.</li>
  <li>Fa l‚Äô11esima entro i 15 minuti ‚Üí viene bloccato.</li>
  <li>Dopo i 15 minuti dalla <strong>prima richiesta</strong>, il conteggio si <strong>resetta automaticamente</strong>.</li>
</ul>

<p>üìå Questo <strong>timer √® individuale per ogni client</strong>, <strong>non parte quando avvii il server</strong>, ma <strong>parte dalla prima richiesta dell‚Äôutente/IP</strong>.</p>

<h6 id="-standardheaders-true">‚ùì <code class="language-plaintext highlighter-rouge">standardHeaders: true</code></h6>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">standardHeaders</span><span class="p">:</span> <span class="kc">true</span>
</code></pre></div></div>

<p>Questa opzione <strong>abilita gli header ufficiali</strong> definiti dalla RFC 6585 per il <strong>rate limiting</strong>.</p>

<h4 id="-esempio-di-intestazioni-incluse-nella-risposta">‚úÖ Esempio di intestazioni incluse nella risposta:</h4>

<pre><code class="language-header">RateLimit-Limit: 10
RateLimit-Remaining: 4
RateLimit-Reset: 1622392800
</code></pre>

<ul>
  <li><code class="language-plaintext highlighter-rouge">RateLimit-Limit</code>: numero massimo di richieste consentite</li>
  <li><code class="language-plaintext highlighter-rouge">RateLimit-Remaining</code>: quante richieste ti restano</li>
  <li><code class="language-plaintext highlighter-rouge">RateLimit-Reset</code>: timestamp UNIX in cui il limite verr√† resettato</li>
</ul>

<p>‚úÖ Molto utile per client (es. frontend) per <strong>sapere quanto manca</strong> prima del reset.</p>

<h4 id="-headers-ricevuti-nella-risposta">üì¶ Headers ricevuti nella risposta:</h4>

<pre><code class="language-header">HTTP/1.1 200 OK 
RateLimit-Limit: 5 
RateLimit-Remaining: 4 
RateLimit-Reset: 1718980500 
Content-Type: application/json
</code></pre>

<ul>
  <li><code class="language-plaintext highlighter-rouge">RateLimit-Limit: 5</code> ‚Üí max 5 richieste</li>
  <li><code class="language-plaintext highlighter-rouge">RateLimit-Remaining: 4</code> ‚Üí ne hai ancora 4 disponibili</li>
  <li><code class="language-plaintext highlighter-rouge">RateLimit-Reset: &lt;timestamp&gt;</code> ‚Üí UNIX timestamp in cui la finestra si resetta</li>
</ul>

<h6 id="-legacyheaders-false">‚ùì <code class="language-plaintext highlighter-rouge">legacyHeaders: false</code></h6>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">legacyHeaders</span><span class="p">:</span> <span class="kc">false</span>
</code></pre></div></div>

<p>Disattiva gli <strong>header non ufficiali</strong>, usati storicamente da molti servizi prima della RFC. Questi includono:</p>

<pre><code class="language-header">X-RateLimit-Limit
X-RateLimit-Remaining
X-RateLimit-Reset
</code></pre>

<p>Questi sono <strong>ancora supportati da molti tool/servizi</strong>, ma sono considerati <strong>obsoleti</strong>.</p>

<p>‚úÖ Impostando <code class="language-plaintext highlighter-rouge">legacyHeaders: false</code>:</p>

<ul>
  <li>Non vengono pi√π inviati.</li>
  <li>Ti limiti ai soli header standard (<code class="language-plaintext highlighter-rouge">RateLimit-*</code>), che sono pi√π compatibili con nuovi client e servizi.</li>
</ul>

<h4 id="3-applicazione-nel-router">3. <strong>Applicazione nel router</strong></h4>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">express</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">express</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">loginRateLimiter</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../middleware/rate-limiter</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">loginController</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../controllers/auth.controller</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nc">Router</span><span class="p">();</span>

<span class="nx">router</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">"</span><span class="s2">/login</span><span class="dl">"</span><span class="p">,</span> <span class="nx">loginRateLimiter</span><span class="p">,</span> <span class="nx">loginController</span><span class="p">);</span>
</code></pre></div></div>

<p>‚úÖ <strong>Risultato</strong>: un utente pu√≤ tentare il login solo 10 volte in 15 minuti da uno stesso IP. Se supera questo limite, ricever√† un errore 429:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"error"</span><span class="p">:</span><span class="w"> </span><span class="s2">"TooManyRequests"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"message"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Troppi tentativi di login. Riprova tra 15 minuti."</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h2 id="-altre-configurazioni-utili">üîÑ Altre configurazioni utili</h2>

<table>
  <thead>
    <tr>
      <th>Opzione</th>
      <th>Significato</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">windowMs</code></td>
      <td>Finestra temporale per contare le richieste (es. 15 minuti)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">max</code></td>
      <td>Numero massimo di richieste per finestra</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">message</code></td>
      <td>Messaggio di errore in caso di superamento limite</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">keyGenerator</code></td>
      <td>Funzione per determinare l‚Äôidentificatore (default: IP)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">skip</code></td>
      <td>Funzione per saltare il rate limit in certi casi</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">handler</code></td>
      <td>Funzione personalizzata quando si supera il limite</td>
    </tr>
  </tbody>
</table>

<h2 id="-altri-usi-tipici">üì¶ Altri usi tipici</h2>

<ul>
  <li><strong>/login</strong> ‚Üí 10 richieste in 15 min</li>
  <li><strong>/forgot-password</strong> ‚Üí 3 richieste in 1 ora</li>
  <li><strong>/register</strong> ‚Üí 5 richieste in 1 ora</li>
  <li><strong>API pubbliche</strong> ‚Üí es. 100 richieste/ora</li>
</ul>

<h2 id="-best-practices">üîê Best practices</h2>

<ul>
  <li>Usa <strong>rate limiting</strong> solo su rotte ‚Äúsensibili‚Äù (auth, email, ecc.)</li>
  <li>Non usare su rotte con traffico lecito ad alta frequenza (es. <code class="language-plaintext highlighter-rouge">/products</code>)</li>
  <li>Logga i tentativi bloccati se vuoi monitorarli</li>
  <li>Combina con altre protezioni (es. CAPTCHA, ban IP, ecc.)</li>
</ul>

<h3 id="user-identityentityts"><code class="language-plaintext highlighter-rouge">user-identity.entity.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">User</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">../../../api/user/user.entity</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="kr">interface</span> <span class="nx">UserIdentity</span> <span class="p">{</span>
  <span class="nl">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="nl">provider</span><span class="p">:</span> <span class="dl">"</span><span class="s2">local</span><span class="dl">"</span><span class="p">;</span>
  <span class="nl">credentials</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">username</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="nl">hashedPassword</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="nl">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">;</span>

  <span class="c1">// Token</span>
  <span class="nl">isActive</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>
  <span class="nl">emailConfirmationSentAt</span><span class="p">?:</span> <span class="nb">Date</span><span class="p">;</span>
  <span class="nl">confirmationToken</span><span class="p">?:</span> <span class="kr">string</span> <span class="o">|</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="nl">resetPasswordToken</span><span class="p">?:</span> <span class="kr">string</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nl">resetPasswordExpires</span><span class="p">?:</span> <span class="nb">Date</span> <span class="o">|</span> <span class="kr">string</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="user-identitymodelts"><code class="language-plaintext highlighter-rouge">user-identity.model.ts</code></h3>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">UserIdentity</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./user-identity.entity</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">mongoose</span><span class="p">,</span> <span class="p">{</span> <span class="nx">Schema</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">mongoose</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">userIdentitySchema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span><span class="o">&lt;</span><span class="nx">UserIdentity</span><span class="o">&gt;</span><span class="p">({</span>
  <span class="na">provider</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="dl">"</span><span class="s2">local</span><span class="dl">"</span> <span class="p">},</span>
  <span class="na">credentials</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">username</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
      <span class="na">hashedPassword</span><span class="p">:</span> <span class="nb">String</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">user</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nx">Schema</span><span class="p">.</span><span class="nx">Types</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span> <span class="na">ref</span><span class="p">:</span> <span class="dl">"</span><span class="s2">User</span><span class="dl">"</span> <span class="p">},</span>

  <span class="c1">// Token</span>
  <span class="na">isActive</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">Boolean</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">false</span> <span class="p">},</span>
  <span class="na">emailConfirmationSentAt</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">Date</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">null</span> <span class="p">},</span>
  <span class="na">confirmationToken</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span> <span class="o">||</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">},</span>
  <span class="na">resetPasswordToken</span><span class="p">:</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="nb">String</span> <span class="o">||</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="kc">null</span><span class="p">,</span> <span class="na">default</span><span class="p">:</span> <span class="kc">undefined</span> <span class="p">},</span>
  <span class="na">resetPasswordExpires</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="nb">Date</span> <span class="o">||</span> <span class="nb">String</span> <span class="o">||</span> <span class="kc">undefined</span><span class="p">,</span>
    <span class="na">default</span><span class="p">:</span> <span class="kc">undefined</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">userIdentitySchema</span><span class="p">.</span><span class="nf">pre</span><span class="p">(</span><span class="dl">"</span><span class="s2">findOne</span><span class="dl">"</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nf">populate</span><span class="p">(</span><span class="dl">"</span><span class="s2">user</span><span class="dl">"</span><span class="p">);</span>
  <span class="nf">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">UserIdentityModel</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="o">&lt;</span><span class="nx">UserIdentity</span><span class="o">&gt;</span><span class="p">(</span><span class="dl">"</span><span class="s2">UserIdentity</span><span class="dl">"</span><span class="p">,</span> <span class="nx">userIdentitySchema</span><span class="p">);</span>
</code></pre></div></div>
